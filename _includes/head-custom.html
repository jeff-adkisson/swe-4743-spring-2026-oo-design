<style>
  /* Diagram container */
  .mermaid-wrap {
    position: relative;
    border: 1px solid #444;
    background: #fff;
    padding: 0.5rem;
    margin: 1rem 0;
  }

  /* Mermaid output block lives inside the wrap */
  .mermaid {
    margin: 0;
  }

  /* Controls */
  .mermaid-copy {
    font-size: 12px;
    line-height: 1;
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid #666;
    background: rgba(255, 255, 255, 0.9);
    color: #000;
    text-decoration: none;
    cursor: pointer;
    user-select: none;
    display: inline-block;
    white-space: nowrap;
    margin-top: 0.5rem;
  }

  .mermaid-copy:hover {
    text-decoration: underline;
  }
</style>

<script type="module">
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.esm.min.mjs";

  mermaid.initialize({
    startOnLoad: false,
    theme: "default",
    flowchart: { useMaxWidth: false }, // prevents Mermaid from shrinking to fit width
    themeVariables: {
      background: "#ffffff",
      primaryColor: "#ffffff",
      primaryTextColor: "#000000",
      lineColor: "#000000",
      textColor: "#000000",
    },
  });

  // -----------------------------
  // Render Mermaid + add controls
  // -----------------------------
  async function renderMermaidFromCodeBlocks() {
    // Jekyll/Kramdown typically renders ```mermaid as:
    // <pre><code class="language-mermaid">...</code></pre>
    const blocks = document.querySelectorAll("pre > code.language-mermaid");

    blocks.forEach((code) => {
      const pre = code.parentElement;

      // Wrapper provides relative positioning for control links
      const wrap = document.createElement("div");
      wrap.className = "mermaid-wrap";

      // Mermaid container (Mermaid reads textContent)
      const container = document.createElement("div");
      container.className = "mermaid";

      const mermaidSource = (code.textContent || "").trimEnd();
      container.textContent = mermaidSource;

      // Copy Mermaid control (below)
      const copy = document.createElement("a");
      copy.href = "#";
      copy.className = "mermaid-copy";
      copy.textContent = "Copy Mermaid";
      copy.setAttribute("aria-label", "Copy Mermaid code to clipboard");
      copy.dataset.mermaidSource = mermaidSource;

      copy.addEventListener("click", async (e) => {
        e.preventDefault();
        const text = copy.dataset.mermaidSource || "";

        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            // Fallback for older browsers
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed";
            ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            document.body.removeChild(ta);
          }

          const old = copy.textContent;
          copy.textContent = "Copied!";
          setTimeout(() => (copy.textContent = old), 1200);
        } catch {
          const old = copy.textContent;
          copy.textContent = "Copy failed";
          setTimeout(() => (copy.textContent = old), 1400);
        }
      });

      wrap.appendChild(container);
      wrap.appendChild(copy);

      pre.replaceWith(wrap);
    });

    // Render all newly created .mermaid blocks
    await mermaid.run({ querySelector: ".mermaid" });

  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", renderMermaidFromCodeBlocks);
  } else {
    renderMermaidFromCodeBlocks();
  }

</script>
